machine:
    node:
        version: 6.2.0
    ruby:
        version: 2.2.0

dependencies:
    pre:
        - gem install aws-sdk
        - npm install -g grunt-cli
        - 'echo //registry.npmjs.org/:_authToken=${PUBLIC_NPM_TOKEN} > ~/.npmrc'
    override:
        - npm install
    post:
        - npm ls --depth=0 > $CIRCLE_ARTIFACTS/package.lock

test:
    override:
        - npm test
        - npm run lint

deployment:
    features:
        branch: /^(?!(?:dev|master)$).+$/
        commands:
            # Clone tool
            - git config --global user.email $STREAMROOT_EMAIL
            - git config --global user.name $STREAMROOT_USERNAME
            - git clone git@github.com:streamroot/toolkit.git

            # Upload dist
            - grunt browserify:bundle
            - grunt browserify:wrapper

            - toolkit/add_banner.rb --file dist/bundle/$DIST_FILE --deploy_env $CIRCLE_BRANCH
            - toolkit/add_banner.rb --file dist/wrapper/$DIST_FILE --deploy_env $CIRCLE_BRANCH

            - cp dist/bundle/$DIST_FILE $CIRCLE_ARTIFACTS/$DIST_FILE
            - cp dist/wrapper/$DIST_FILE $CIRCLE_ARTIFACTS/$DIST_FILE_LITE

            - toolkit/upload_to_s3.rb --bucket $S3_FEATURES_BUCKET
                                      --region eu-west-1
                                      --file $CIRCLE_ARTIFACTS/$DIST_FILE
                                      --destinations $CIRCLE_PROJECT_REPONAME/$CIRCLE_BRANCH/$DIST_FILE
                                      --key $S3_KEY
                                      --secret $S3_SECRET
            - toolkit/upload_to_s3.rb --bucket $S3_FEATURES_BUCKET
                                      --region eu-west-1
                                      --file $CIRCLE_ARTIFACTS/$DIST_FILE_LITE
                                      --destinations $CIRCLE_PROJECT_REPONAME/$CIRCLE_BRANCH/$DIST_FILE_LITE
                                      --key $S3_KEY
                                      --secret $S3_SECRET

    staging:
        branch: dev
        commands:
            # Clone tools
            - git config --global user.email $STREAMROOT_EMAIL
            - git config --global user.name $STREAMROOT_USERNAME
            - git clone git@github.com:streamroot/bridge.git
            - git clone git@github.com:streamroot/toolkit.git

            # Cleanup
            - rm -rf dist

            # Generate dist
            - grunt browserify:bundle
            - grunt browserify:wrapper

            - toolkit/add_banner.rb --file dist/bundle/$DIST_FILE
                                    --deploy_env staging
                                    --version $(toolkit/current_version.rb --beta ${CIRCLE_BUILD_NUM})
            - toolkit/add_banner.rb --file dist/wrapper/$DIST_FILE
                                    --deploy_env staging
                                    --version $(toolkit/current_version.rb --beta ${CIRCLE_BUILD_NUM})

            - cp dist/bundle/$DIST_FILE $CIRCLE_ARTIFACTS/$DIST_FILE
            - cp dist/wrapper/$DIST_FILE $CIRCLE_ARTIFACTS/$DIST_FILE_LITE

            # Build package.json
            - toolkit/build_dist_package.rb --version $(toolkit/current_version.rb --beta ${CIRCLE_BUILD_NUM})
                                            --main ./$DIST_FILE
                                            -o dist/bundle/package.json
            - toolkit/build_dist_package.rb --version $(toolkit/current_version.rb --beta ${CIRCLE_BUILD_NUM})
                                            --main ./$DIST_FILE
                                            --name hlsjs-p2p-wrapper
                                            -o dist/wrapper/package.json

            # Publish
            - npm publish dist/bundle --tag beta
            - npm publish dist/wrapper --tag beta

            # Upload version
            - toolkit/upload_to_s3.rb --bucket $S3_STAGING_BUCKET
                                      --region eu-west-1
                                      --file $CIRCLE_ARTIFACTS/$DIST_FILE
                                      --destinations $CIRCLE_PROJECT_REPONAME/$(toolkit/current_version.rb --beta ${CIRCLE_BUILD_NUM})/$DIST_FILE
                                                     $CIRCLE_PROJECT_REPONAME/latest/$DIST_FILE
                                      --key $S3_KEY
                                      --secret $S3_SECRET
            - toolkit/upload_to_s3.rb --bucket $S3_STAGING_BUCKET
                                      --region eu-west-1
                                      --file $CIRCLE_ARTIFACTS/$DIST_FILE_LITE
                                      --destinations $CIRCLE_PROJECT_REPONAME/$(toolkit/current_version.rb --beta ${CIRCLE_BUILD_NUM})/$DIST_FILE_LITE
                                                     $CIRCLE_PROJECT_REPONAME/latest/$DIST_FILE_LITE
                                      --key $S3_KEY
                                      --secret $S3_SECRET

            # Changelog
            - toolkit/post_changelog.rb   --project $CIRCLE_PROJECT_REPONAME
                                          --env staging
                                          --subtitle $ALERTING_SUBTITLE
                                          --channel $ALERTING_CHANNEL
                                          --slack-token $SLACK_TOKEN
                                          --username $ALERTING_USERNAME
                                          --icon-url $ALERTING_PICTURE

            # Run bridge
            - bridge/run.rb --current_module $CIRCLE_PROJECT_REPONAME --trigger_branch dev --token $BRIDGE_TOKEN

    preprod:
        branch: master
        commands:
            # Clone tools
            - git config --global user.email $STREAMROOT_EMAIL
            - git config --global user.name $STREAMROOT_USERNAME
            - git clone git@github.com:streamroot/bridge.git
            - git clone git@github.com:streamroot/toolkit.git

            # Changelog
            - toolkit/bump_current_changelog.rb --version $(toolkit/current_version.rb)

            # Update version
            - toolkit/update_version.rb

            # Cleanup
            - rm -rf dist

            # Generate dist
            - grunt browserify:bundle
            - grunt browserify:wrapper

            - toolkit/add_banner.rb --file dist/bundle/$DIST_FILE
                                    --version $(toolkit/current_version.rb --beta ${CIRCLE_BUILD_NUM})
            - toolkit/add_banner.rb --file dist/wrapper/$DIST_FILE
                                    --version $(toolkit/current_version.rb --beta ${CIRCLE_BUILD_NUM})

            - cp dist/bundle/$DIST_FILE $CIRCLE_ARTIFACTS/$DIST_FILE
            - cp dist/wrapper/$DIST_FILE $CIRCLE_ARTIFACTS/$DIST_FILE_LITE

            # Build package.json
            - toolkit/build_dist_package.rb --version $(toolkit/current_version.rb)
                                            --main ./$DIST_FILE
                                            -o dist/bundle/package.json
            - toolkit/build_dist_package.rb --version $(toolkit/current_version.rb)
                                            --main ./$DIST_FILE
                                            -o dist/wrapper/package.json
                                            --name hlsjs-p2p-wrapper

            # Publish
            - npm publish dist/bundle
            - npm publish dist/wrapper

            # Upload version
            - toolkit/upload_to_s3.rb --bucket $S3_PREPROD_BUCKET
                                      --region eu-west-1
                                      --file $CIRCLE_ARTIFACTS/$DIST_FILE
                                      --destinations $CIRCLE_PROJECT_REPONAME/$(toolkit/current_version.rb --major)/$DIST_FILE
                                                     $CIRCLE_PROJECT_REPONAME/$(toolkit/current_version.rb --no_patch)/$DIST_FILE
                                                     $CIRCLE_PROJECT_REPONAME/$(toolkit/current_version.rb)/$DIST_FILE
                                                     $CIRCLE_PROJECT_REPONAME/latest/$DIST_FILE
                                      --key $S3_KEY
                                      --secret $S3_SECRET
            - toolkit/upload_to_s3.rb --bucket $S3_PREPROD_BUCKET
                                      --region eu-west-1
                                      --file $CIRCLE_ARTIFACTS/$DIST_FILE_LITE
                                      --destinations $CIRCLE_PROJECT_REPONAME/$(toolkit/current_version.rb --major)/$DIST_FILE_LITE
                                                     $CIRCLE_PROJECT_REPONAME/$(toolkit/current_version.rb --no_patch)/$DIST_FILE_LITE
                                                     $CIRCLE_PROJECT_REPONAME/$(toolkit/current_version.rb)/$DIST_FILE_LITE
                                                     $CIRCLE_PROJECT_REPONAME/latest/$DIST_FILE_LITE
                                      --key $S3_KEY
                                      --secret $S3_SECRET

            # Changelog
            - toolkit/post_changelog.rb   --project $CIRCLE_PROJECT_REPONAME
                                          --env preprod
                                          --subtitle $ALERTING_SUBTITLE
                                          --channel $ALERTING_CHANNEL
                                          --slack-token $SLACK_TOKEN
                                          --username $ALERTING_USERNAME
                                          --icon-url $ALERTING_PICTURE

            # Run bridge
            - bridge/run.rb --current_module $CIRCLE_PROJECT_REPONAME --trigger_branch master --token $BRIDGE_TOKEN
